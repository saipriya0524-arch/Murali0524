<script>
let tools = [];
let favs = JSON.parse(localStorage.getItem("favs") || "[]");
let recents = JSON.parse(localStorage.getItem("recents") || "[]");

const grid = document.getElementById("grid");
const favGrid = document.getElementById("favGrid");
const recentGrid = document.getElementById("recentGrid");
const search = document.getElementById("search");
const categoryFilter = document.getElementById("categoryFilter");

/* ---------- CATEGORY DETECTION ---------- */
function detectCategory(text) {
  text = text.toLowerCase();
  const rules = [
    { k:["ai","gpt","openai","image","generate"], v:"AI" },
    { k:["game","play","arcade"], v:"Games" },
    { k:["pdf","doc","file","convert"], v:"Productivity" },
    { k:["job","resume","career","hire"], v:"Jobs" },
    { k:["learn","course","tutorial"], v:"Learning" },
    { k:["security","virus","scan","malware"], v:"Security" },
    { k:["design","photo","ui"], v:"Design" },
    { k:["video","audio","media"], v:"Media" },
    { k:["github","code","dev"], v:"Development" }
  ];
  for (const r of rules) {
    if (r.k.some(k => text.includes(k))) return r.v;
  }
  return "Other";
}

/* ---------- SHEET LOADER (DB SAFE) ---------- */
async function loadSheetData() {
  const url =
    "https://docs.google.com/spreadsheets/d/1_lz8NoO69rbSpE0yyTgJaxy0erMFmcvK1L88P40JJlY/gviz/tq?gid=1452664636&tqx=out:json";

  const res = await fetch(url);
  const text = await res.text();
  const json = JSON.parse(text.substring(47).slice(0, -2));

  /* Normalize headers safely */
  const headers = {};
  json.table.cols.forEach((c, i) => {
    if (c.label) {
      headers[c.label.trim().toLowerCase()] = i;
    }
  });

  if (headers.url === undefined) {
    console.error("❌ 'url' column not found in sheet");
    return;
  }

  tools = [];

  json.table.rows.forEach(r => {
    const link = r.c[headers.url]?.v;
    if (!link) return;

    const desc =
      headers.desc !== undefined ? r.c[headers.desc]?.v || "" : "";

    tools.push({
      url: link.trim(),
      desc: desc,
      cat: detectCategory(link + " " + desc)
    });
  });

  buildCategories();
  render();
}

/* ---------- UI ---------- */
function buildCategories() {
  categoryFilter.innerHTML = `<option value="all">All Categories</option>`;
  [...new Set(tools.map(t => t.cat))].sort().forEach(c => {
    const o = document.createElement("option");
    o.value = c;
    o.textContent = c;
    categoryFilter.appendChild(o);
  });
}

function makeCard(t) {
  const card = document.createElement("div");
  card.className = "card";

  const star = document.createElement("div");
  star.className = "star" + (favs.includes(t.url) ? " active" : "");
  star.textContent = "★";

  star.onclick = e => {
    e.stopPropagation();
    favs.includes(t.url)
      ? favs = favs.filter(x => x !== t.url)
      : favs.push(t.url);
    localStorage.setItem("favs", JSON.stringify(favs));
    render();
  };

  card.innerHTML = `
    <a class="title" href="${t.url}" target="_blank">
      ${t.url.replace(/^https?:\/\//,"")}
    </a>
    <div class="desc">${t.desc}</div>
    <div class="category">${t.cat}</div>
  `;

  card.appendChild(star);

  card.onclick = () => {
    recents = [t.url, ...recents.filter(x => x !== t.url)].slice(0,5);
    localStorage.setItem("recents", JSON.stringify(recents));
    render();
  };

  return card;
}

function render() {
  grid.innerHTML = favGrid.innerHTML = recentGrid.innerHTML = "";

  const q = search.value.toLowerCase();
  const c = categoryFilter.value;

  tools.forEach(t => {
    if (
      (q && !t.url.toLowerCase().includes(q) &&
       !t.desc.toLowerCase().includes(q)) ||
      (c !== "all" && t.cat !== c)
    ) return;

    grid.appendChild(makeCard(t));
  });

  favs.forEach(f => {
    const t = tools.find(x => x.url === f);
    if (t) favGrid.appendChild(makeCard(t));
  });

  recents.forEach(r => {
    const t = tools.find(x => x.url === r);
    if (t) recentGrid.appendChild(makeCard(t));
  });
}

/* ---------- EVENTS ---------- */
search.oninput = render;
categoryFilter.onchange = render;

loadSheetData();
</script>
