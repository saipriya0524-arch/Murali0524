<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>ToolHub</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
:root{
  --bg:#0f0f0f;
  --card:#1b1b1b;
  --text:#ffffff;
  --muted:#aaa;
  --accent:#4dabf7;
}
.light{
  --bg:#f2f4f7;
  --card:#ffffff;
  --text:#111;
  --muted:#555;
  --accent:#2563eb;
}
body{
  margin:0;
  padding:80px 20px 40px;
  font-family:Arial,sans-serif;
  background:var(--bg);
  color:var(--text);
}

/* HEADER */
#themeToggle{
  position:fixed;
  top:16px;
  right:16px;
  width:46px;
  height:46px;
  border-radius:50%;
  border:none;
  font-size:20px;
  cursor:pointer;
  background:var(--card);
  color:var(--text);
}
h1{text-align:center;margin-bottom:20px;}

/* CONTROLS */
.controls{
  display:flex;
  gap:10px;
  justify-content:center;
  flex-wrap:wrap;
}
input,select,button{
  padding:10px 12px;
  border-radius:8px;
  border:none;
}
button{background:#444;color:#fff;cursor:pointer;}

#lastUpdated{
  margin:18px auto 40px;
  text-align:center;
  font-size:12px;
  opacity:.6;
}

/* SECTIONS */
.section{margin-bottom:48px;}
.section h2{margin-bottom:18px;font-size:18px;}

/* GRID */
.grid{
  display:grid;
  grid-template-columns:repeat(auto-fill,minmax(260px,1fr));
  gap:18px;
}

/* CARD (FIXED SIZE) */
.card{
  background:var(--card);
  padding:14px;
  border-radius:14px;
  position:relative;
  min-height:128px; /* FIX */
  transition:.25s;
}
.card:hover{
  transform:translateY(-6px);
  box-shadow:0 14px 32px rgba(0,0,0,.45);
}

/* CONTENT */
.title{
  display:flex;
  align-items:center;
  gap:8px;
  font-weight:bold;
  color:var(--accent);
  text-decoration:none;
}
.favicon{
  width:14px;
  height:14px;
  border-radius:50%;
  flex-shrink:0;
}
.desc{color:var(--muted);margin:6px 0;}
.badge{
  font-size:11px;
  padding:4px 10px;
  border-radius:999px;
  display:inline-block;
}

/* CATEGORY COLORS */
.badge.ai{background:#1e40af;color:#dbeafe;}
.badge.writing{background:#065f46;color:#d1fae5;}
.badge.image{background:#7c2d12;color:#ffedd5;}
.badge.video{background:#6b21a8;color:#f3e8ff;}
.badge.developer{background:#1f2937;color:#e5e7eb;}
.badge.search{background:#92400e;color:#fef3c7;}
.badge.productivity{background:#155e75;color:#cffafe;}
.badge.other{background:#374151;color:#e5e7eb;}

/* STATUS */
.status{
  position:absolute;
  bottom:12px;
  right:12px;
  display:flex;
  gap:6px;
  font-size:12px;
}
.dot{width:8px;height:8px;border-radius:50%;}
.working{background:#22c55e;}
.broken{background:#ef4444;}
.redirect{background:#facc15;}
.unknown{background:#9ca3af;}

/* FAVORITE */
.star{
  position:absolute;
  top:12px;
  right:12px;
  font-size:18px;
  cursor:pointer;
  color:#777;
  transition:.2s;
}
.star:hover{color:#facc15;}
.star.active{color:#f59e0b;}

/* MOBILE */
@media(max-width:640px){
  body{padding:70px 12px 30px;}
  h1{font-size:22px;}
}
</style>
</head>

<body>

<button id="themeToggle">üåô</button>
<h1>üß† ToolHub</h1>

<div class="controls">
  <input id="search" placeholder="Search tools‚Ä¶">
  <select id="categoryFilter"><option value="all">All Categories</option></select>
  <button id="clearBtn">Clear</button>
  <button id="refreshBtn">Refresh</button>
</div>

<div id="lastUpdated"></div>

<div class="section">
  <h2>‚≠ê Favorites</h2>
  <div id="favGrid" class="grid"></div>
</div>

<div class="section">
  <h2>üïí Recent</h2>
  <div id="recentGrid" class="grid"></div>
</div>

<div class="section">
  <h2>üì¶ All Tools</h2>
  <div id="grid" class="grid"></div>
</div>

<script>
const SHEET_URL =
"https://docs.google.com/spreadsheets/d/1_lz8NoO69rbSpE0yyTgJaxy0erMFmcvK1L88P40JJlY/gviz/tq?gid=1452664636&tqx=out:json";

const grid = document.getElementById("grid");
const favGrid = document.getElementById("favGrid");
const recentGrid = document.getElementById("recentGrid");
const search = document.getElementById("search");
const categoryFilter = document.getElementById("categoryFilter");
const clearBtn = document.getElementById("clearBtn");
const refreshBtn = document.getElementById("refreshBtn");

let data=[];
let favorites=JSON.parse(localStorage.getItem("favorites")||"[]");
let recent=JSON.parse(localStorage.getItem("recent")||"[]");

/* HELPERS */
function titleFromUrl(url){
  try{
    const h=new URL(url).hostname.replace("www.","");
    return h.split(".")[0].replace(/^\w/,c=>c.toUpperCase());
  }catch{return "Link";}
}
function safeHostname(url){
  try{return new URL(url).hostname;}catch{return "";}
}
function categoryClass(cat){
  return cat.toLowerCase().replace(/\s+/g,"");
}

/* CATEGORY GUESSER */
function guessCategory(text){
  text=text.toLowerCase();
  if(/ai|gpt|llm/.test(text)) return "AI";
  if(/write|grammar|text/.test(text)) return "Writing";
  if(/image|photo/.test(text)) return "Image";
  if(/video|game/.test(text)) return "Video";
  if(/code|dev/.test(text)) return "Developer";
  if(/search/.test(text)) return "Search";
  if(/pdf|doc|ebook/.test(text)) return "Productivity";
  return "Other";
}

/* LOAD WITH CACHE (CATEGORY FIX APPLIED) */
async function loadData(force=false){
  if(!force && sessionStorage.getItem("toolhub-data")){
    data=JSON.parse(sessionStorage.getItem("toolhub-data"));
    render();
    return;
  }

  const res=await fetch(SHEET_URL);
  const txt=await res.text();
  const json=JSON.parse(txt.substring(47).slice(0,-2));

  const cols=json.table.cols.map(c=>c.label.toLowerCase());
  const i={
    url:cols.indexOf("url"),
    cat:cols.indexOf("category"),
    desc:cols.indexOf("description"),
    label:cols.indexOf("status_label")
  };

  data=json.table.rows.map(r=>{
    const url=r.c[i.url]?.v||"";
    const desc=r.c[i.desc]?.v||"";
    const rawCat=(r.c[i.cat]?.v||"").trim().toLowerCase();
    const generic=["utilities","other",""];
    const cat=generic.includes(rawCat)
      ? guessCategory(url+" "+desc)
      : r.c[i.cat].v;
    return{url,desc,cat,label:r.c[i.label]?.v||"Unknown"};
  }).filter(d=>d.url.startsWith("http"));

  sessionStorage.setItem("toolhub-data",JSON.stringify(data));

  const cats=new Set(data.map(d=>d.cat));
  categoryFilter.innerHTML='<option value="all">All Categories</option>';
  [...cats].sort().forEach(c=>{
    const o=document.createElement("option");
    o.value=o.textContent=c;
    categoryFilter.appendChild(o);
  });

  document.getElementById("lastUpdated").innerText=
    "Last updated: "+new Date().toLocaleString();

  render();
}

/* CARD */
function createCard(t){
  let dot="unknown";
  const l=t.label.toLowerCase();
  if(l.includes("working")) dot="working";
  else if(l.includes("redirect")) dot="redirect";
  else if(l.includes("blocked")||l.includes("not")) dot="broken";

  const card=document.createElement("div");
  card.className="card";
  const fav=favorites.includes(t.url);

  card.innerHTML=`
    <span class="star ${fav?"active":""}">‚òÖ</span>
    <a class="title" href="${t.url}" target="_blank">
      <img class="favicon"
           src="https://www.google.com/s2/favicons?domain=${safeHostname(t.url)}"
           onerror="this.style.display='none'">
      ${titleFromUrl(t.url)}
    </a>
    <div class="badge ${categoryClass(t.cat)}">${t.cat}</div>
    <div class="desc">${t.desc}</div>
    <div class="status"><span class="dot ${dot}"></span>${t.label}</div>
  `;

  card.querySelector(".star").onclick=e=>{
    e.stopPropagation();
    fav ? favorites=favorites.filter(f=>f!==t.url) : favorites.push(t.url);
    localStorage.setItem("favorites",JSON.stringify(favorites));
    render();
  };

  card.querySelector("a").onclick=()=>{
    recent=recent.filter(r=>r!==t.url);
    recent.unshift(t.url);
    recent=recent.slice(0,5);
    localStorage.setItem("recent",JSON.stringify(recent));
  };

  return card;
}

/* RENDER */
function render(){
  grid.innerHTML=favGrid.innerHTML=recentGrid.innerHTML="";
  const q=search.value.toLowerCase();
  const c=categoryFilter.value;

  const filtered=data.filter(t=>{
    if(q && !t.url.toLowerCase().includes(q) && !t.desc.toLowerCase().includes(q)) return false;
    if(c!=="all" && t.cat!==c) return false;
    return true;
  });

  filtered.filter(t=>favorites.includes(t.url)).forEach(t=>favGrid.appendChild(createCard(t)));
  recent.map(r=>filtered.find(t=>t.url===r)).filter(Boolean).forEach(t=>recentGrid.appendChild(createCard(t)));
  filtered.forEach(t=>grid.appendChild(createCard(t)));
}

search.oninput=render;
categoryFilter.onchange=render;
clearBtn.onclick=()=>{search.value="";categoryFilter.value="all";render();}
refreshBtn.onclick=()=>{sessionStorage.clear();loadData(true);};

loadData();
</script>

</body>
</html>
